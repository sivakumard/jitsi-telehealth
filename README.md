# Jitsi Telehealth Deployment

Kubernetes deployment for Jitsi Meet configured for telehealth services with authentication and no watermark.

## Features

- ✅ **JWT Authentication** - API key/secret authentication for OpenEMR integration
- ✅ **No individual user accounts** - Tokens generated by OpenEMR on-the-fly
- ✅ **Moderator control** - Doctors/providers have moderator privileges
- ✅ **No Jitsi watermark** - Clean, professional interface
- ✅ **Custom domain** - https://telehealth.apps-o.hinisoft.com
- ✅ **TLS/SSL enabled** - Secure HTTPS connections
- ✅ **Persistent storage** - Configuration persists across restarts
- ✅ **OpenEMR integration scripts** - PHP and Python examples included

## Architecture

The deployment consists of 4 main components:

1. **Prosody** - XMPP server for authentication and signaling
2. **Jicofo** - Jitsi Conference Focus for managing conferences
3. **JVB** - Jitsi Videobridge for handling media streams
4. **Web** - Web interface for users

## Prerequisites

- Kubernetes cluster with Longhorn storage
- NGINX Ingress Controller
- cert-manager for TLS certificates
- DNS record pointing `telehealth.apps-o.hinisoft.com` to your ingress

## Deployment

### 1. Deploy all manifests

```bash
kubectl apply -f manifests/dev/
```

### 2. Wait for all pods to be running

```bash
kubectl get pods -n jitsi -w
```

### 3. Configure JWT Secret

Generate a secure JWT secret:

```bash
openssl rand -hex 32
```

Update the secret in `manifests/dev/02-secrets.yaml`:
```yaml
JWT_APP_SECRET: "your-generated-secret-here"
```

Also update the same secret in OpenEMR integration scripts:
- `openemr-integration/generate-jwt-token.php`
- `openemr-integration/generate_jwt_token.py`

### 4. Redeploy with new secret

```bash
kubectl delete -f manifests/dev/02-secrets.yaml
kubectl apply -f manifests/dev/02-secrets.yaml
kubectl rollout restart deployment -n jitsi
```

```bash
kubectl get all -n jitsi
```

## Configuration

### JWT Authentication

JWT (JSON Web Token) authentication is enabled for OpenEMR integration:
- `ENABLE_AUTH=1` - Requires JWT token to join meetings
- `AUTH_TYPE=jwt` - Uses JWT for authentication
- `JWT_APP_ID=openemr_telehealth` - Application identifier
- `JWT_ACCEPTED_ISSUERS=openemr` - Token issuer
- `JWT_ACCEPTED_AUDIENCES=openemr_telehealth` - Token audience

### Watermark Removal

Watermark is disabled with:
- `DISABLE_WATERMARK=true`
- `INTERFACE_CONFIG_SHOW_JITSI_WATERMARK=false`
- `INTERFACE_CONFIG_SHOW_WATERMARK_FOR_GUESTS=false`
- `INTERFACE_CONFIG_SHOW_BRAND_WATERMARK=false`

### Domain Configuration

- **Public URL**: https://telehealth.apps-o.hinisoft.com
- **XMPP Domain**: meet.jitsi
- **Auth Domain**: auth.meet.jitsi

## OpenEMR Integration

### Generate JWT Tokens

OpenEMR generates JWT tokens to create meeting links for patients and providers.

**PHP Example:**
```bash
cd openemr-integration
composer install
php generate-jwt-token.php "appointment-123" "Dr. Smith" "dr.smith@clinic.com" true
```

**Python Example:**
```bash
cd openemr-integration
pip install -r requirements.txt
python generate_jwt_token.py "appointment-123" "Dr. Smith" "dr.smith@clinic.com" --moderator
```

See [openemr-integration/README.md](openemr-integration/README.md) for detailed integration guide.

### Token Payload

Tokens contain:
- Room name (e.g., appointment ID)
- User name and email
- Moderator status (true for doctors, false for patients)
- Expiration time (default: 1 hour)

### Meeting URL Format

```
https://telehealth.apps-o.hinisoft.com/<room-name>?jwt=<token>
```

## Accessing Jitsi

1. **OpenEMR generates** a JWT token with meeting details
2. **Meeting URL** is created with the token
3. **Send URL** to patient/provider via email/SMS
4. **User clicks link** and joins automatically (no login required)

## Troubleshooting

### Check pod logs

```bash
# Web interface
kubectl logs -n jitsi deployment/web

# Prosody (XMPP)
kubectl logs -n jitsi deployment/prosody

# Jicofo
kubectl logs -n jitsi deployment/jicofo

# JVB
kubectl logs -n jitsi deployment/jvb
```

### Check services

```bash
kubectl get svc -n jitsi
```

### Check ingress

```bash
kubectl get ingress -n jitsi
kubectl describe ingress jitsi-ingress -n jitsi
```

### Verify TLS certificate

```bash
kubectl get certificate -n jitsi
```

## Scaling

### Scale JVB for more capacity

```bash
kubectl scale deployment jvb -n jitsi --replicas=3
```

## Security Notes

1. **Change JWT_APP_SECRET** in `02-secrets.yaml` before deploying to production
2. **Use strong secrets** - Generate with `openssl rand -hex 32`
3. **Keep secrets secure** - Never commit to version control
4. **Short token expiration** - Default 1 hour is recommended
5. **Use HTTPS only** - Tokens should never be sent over HTTP
6. **Regularly update** Jitsi images to get security patches
7. **Monitor access logs** for suspicious activity

## Storage

Each component has persistent storage:
- Web config: 1Gi
- Prosody config: 1Gi
- Jicofo config: 1Gi
- JVB config: 1Gi

## Network Ports

- **80/443** - HTTP/HTTPS (Web interface)
- **5222** - XMPP client connections
- **5347** - XMPP component connections
- **10000/UDP** - RTP media (exposed via NodePort 30000)

## Support

For issues or questions, refer to:
- [Jitsi Documentation](https://jitsi.github.io/handbook/)
- [Jitsi Community](https://community.jitsi.org/)
